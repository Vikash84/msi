#!/usr/bin/env bash
# =========================================================
# Copyright 2019-2020,  Nuno A. Fonseca (nuno dot fonseca at gmail dot com)
#
#
# This is free software: you can redistribute it and/or modify
# it under the terms of the GNU General Public License as published by
# the Free Software Foundation, either version 3 of the License, or
# (at your option) any later version.
#
# This is distributed in the hope that it will be useful,
# but WITHOUT ANY WARRANTY; without even the implied warranty of
# MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
# GNU General Public License for more details.
# 
# You should have received a copy of the GNU General Public License
# along with this file.  If not, see <http://www.gnu.org/licenses/>.
#
#
# =========================================================

## looks for a results.tsv.gz file in the current folder
def_file=
#results.tsv.gz

function usage {
    echo "Usage: msi_display_report  [options]  ";
    echo "Options:"
    echo " -P port : by default it will pick a random port";
    echo " -I ip : ip address where the server will listen for connections";
    echo " -n report name : report name";
    echo " -t tsv_file : tsv file generated by msi";
    echo " -h : this help";
}

ifile=$def_file
PORT=
HOST=
REP_NAME=
DEBUG=0

while getopts "t:P:I:n:h"  Option
do
    case $Option in
	t) ifile=$OPTARG;;
	P) PORT=$OPTARG;;
	I) HOST=$OPTARG;;
	n) REP_NAME=" - $OPTARG";;
	d) DEBUG=1;;
	h ) usage; exit;;
    esac
done

if [ "$ifile-" == "-" ]; then
    echo "ERROR: -t parameter missing."
    exit 1
fi
## We should provide the full path to shiny
ifile=`readlink -f $ifile`
echo "Looking for $ifile"
if [ ! -e $ifile ]; then
    echo "ERROR: $ifile not found"
    exit 1
fi

## R markdown file should be in the same folder as the msi_display_script
path2script=$(dirname $BASH_SOURCE)

## check if .RMD is found
RMD_FILE="$path2script/../template/dashboard.Rmd"
if [ ! -e  $RMD_FILE ]; then
    echo "ERROR: unable to file report template $RMD_FILE"
    exit 1
fi

## allow some options to be overridden
if [ "$PORT-" == "-" ]; then
  PORT=NULL
fi
if [ "$HOST-" == "-" ]; then
  HOST="127.0.0.1"
fi

set -e 
## run the app
R --vanilla  <<EOF
library(rmarkdown)
library(flexdashboard)
library(shiny)

ifile<-"$ifile"
# simple invocation
rmarkdown::run(file="$RMD_FILE",shiny_args = list("launch.browser"=TRUE, port=$PORT, host="$HOST"),render_args=list(params=list(set_title=paste0("MSI report ","$REP_NAME"))))
EOF

exit 0
